<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        struct-to-map ::
        smantics â€” truth through language
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Occasionally in go we want convert our structured data into an unstructured format, such as a map[string]interface{}
for struct like:
type Foo struct { A Bar `json:&amp;#34;a&amp;#34;` B Bar `json:&amp;#34;b&amp;#34;` C Bar `json:&amp;#34;c&amp;#34;` D Bar `json:&amp;#34;d&amp;#34;` E Bar `json:&amp;#34;e&amp;#34;` F int `json:&amp;#34;f&amp;#34;` G uint `json:&amp;#34;g&amp;#34;` H string `json:&amp;#34;h&amp;#34;` } type Bar struct { Bar string `json:&amp;#34;bar&amp;#34;` } There are a couple ways we can convert it into a map.
 manually  func base(foo Foo) map[string]interface{} { result := make(map[string]interface{}) result[&amp;#34;A&amp;#34;] = foo."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://blog.smantic.dev/posts/struct-to-map/" />





<link rel="stylesheet" href="https://blog.smantic.dev/assets/style.css" />

<link rel="stylesheet" href="https://blog.smantic.dev/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://blog.smantic.dev/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://blog.smantic.dev/img/favicon.png" />


<link href="https://blog.smantic.dev/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://blog.smantic.dev/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://blog.smantic.dev/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://blog.smantic.dev/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://blog.smantic.dev/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://blog.smantic.dev/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="struct-to-map"/>
<meta name="twitter:description" content="Occasionally in go we want convert our structured data into an unstructured format, such as a map[string]interface{}
for struct like:
type Foo struct { A Bar `json:&#34;a&#34;` B Bar `json:&#34;b&#34;` C Bar `json:&#34;c&#34;` D Bar `json:&#34;d&#34;` E Bar `json:&#34;e&#34;` F int `json:&#34;f&#34;` G uint `json:&#34;g&#34;` H string `json:&#34;h&#34;` } type Bar struct { Bar string `json:&#34;bar&#34;` } There are a couple ways we can convert it into a map.
 manually  func base(foo Foo) map[string]interface{} { result := make(map[string]interface{}) result[&#34;A&#34;] = foo."/>



<meta property="og:title" content="struct-to-map" />
<meta property="og:description" content="Occasionally in go we want convert our structured data into an unstructured format, such as a map[string]interface{}
for struct like:
type Foo struct { A Bar `json:&#34;a&#34;` B Bar `json:&#34;b&#34;` C Bar `json:&#34;c&#34;` D Bar `json:&#34;d&#34;` E Bar `json:&#34;e&#34;` F int `json:&#34;f&#34;` G uint `json:&#34;g&#34;` H string `json:&#34;h&#34;` } type Bar struct { Bar string `json:&#34;bar&#34;` } There are a couple ways we can convert it into a map.
 manually  func base(foo Foo) map[string]interface{} { result := make(map[string]interface{}) result[&#34;A&#34;] = foo." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.smantic.dev/posts/struct-to-map/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-26T21:02:11-05:00" />
<meta property="article:modified_time" content="2021-10-31T19:47:31-05:00" /><meta property="og:site_name" content="smantics" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >smantics</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/readme">readme</a></li>
        
      
        
          <li><a href="/showcase">showcase</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/readme">readme</a></li>
      
    
      
        <li><a href="/showcase">showcase</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">struct-to-map</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2021-10-26
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://blog.smantic.dev/tags/go/">#go</a>&nbsp;
        
          <a href="https://blog.smantic.dev/tags/benchmark/">#benchmark</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Occasionally in go we want convert our structured data into an unstructured format, such as a <code>map[string]interface{}</code></p>
<p>for struct like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Foo</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">A</span> <span style="color:#a6e22e">Bar</span>    <span style="color:#e6db74">`json:&#34;a&#34;`</span>
	<span style="color:#a6e22e">B</span> <span style="color:#a6e22e">Bar</span>    <span style="color:#e6db74">`json:&#34;b&#34;`</span>
	<span style="color:#a6e22e">C</span> <span style="color:#a6e22e">Bar</span>    <span style="color:#e6db74">`json:&#34;c&#34;`</span>
	<span style="color:#a6e22e">D</span> <span style="color:#a6e22e">Bar</span>    <span style="color:#e6db74">`json:&#34;d&#34;`</span>
	<span style="color:#a6e22e">E</span> <span style="color:#a6e22e">Bar</span>    <span style="color:#e6db74">`json:&#34;e&#34;`</span>
	<span style="color:#a6e22e">F</span> <span style="color:#66d9ef">int</span>    <span style="color:#e6db74">`json:&#34;f&#34;`</span>
	<span style="color:#a6e22e">G</span> <span style="color:#66d9ef">uint</span>   <span style="color:#e6db74">`json:&#34;g&#34;`</span>
	<span style="color:#a6e22e">H</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;h&#34;`</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Bar</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Bar</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;bar&#34;`</span>
}
</code></pre></div><p>There are a couple ways we can convert it into a map.</p>
<ol>
<li>manually</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">base</span>(<span style="color:#a6e22e">foo</span> <span style="color:#a6e22e">Foo</span>) <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{} {

	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{})

	<span style="color:#a6e22e">result</span>[<span style="color:#e6db74">&#34;A&#34;</span>] = <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">A</span>
	<span style="color:#a6e22e">result</span>[<span style="color:#e6db74">&#34;B&#34;</span>] = <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">B</span>
	<span style="color:#a6e22e">result</span>[<span style="color:#e6db74">&#34;C&#34;</span>] = <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">C</span>
	<span style="color:#a6e22e">result</span>[<span style="color:#e6db74">&#34;D&#34;</span>] = <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">D</span>
	<span style="color:#a6e22e">result</span>[<span style="color:#e6db74">&#34;E&#34;</span>] = <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">E</span>
	<span style="color:#a6e22e">result</span>[<span style="color:#e6db74">&#34;F&#34;</span>] = <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">F</span>
	<span style="color:#a6e22e">result</span>[<span style="color:#e6db74">&#34;G&#34;</span>] = <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">G</span>
	<span style="color:#a6e22e">result</span>[<span style="color:#e6db74">&#34;H&#34;</span>] = <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">H</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
}
</code></pre></div><p>just manually assigning the fields and keys.</p>
<ol start="2">
<li>reflection</li>
</ol>
<p>We can use reflection to generically get the name of the struct fields and their data.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">reflec</span>(<span style="color:#a6e22e">foo</span> <span style="color:#a6e22e">Foo</span>) <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{} {

	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{})

	<span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">ValueOf</span>(<span style="color:#a6e22e">foo</span>)
	<span style="color:#a6e22e">typ</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">foo</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">val</span>.<span style="color:#a6e22e">NumField</span>(); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">field</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">val</span>.<span style="color:#a6e22e">Field</span>(<span style="color:#a6e22e">i</span>)
		<span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">typ</span>.<span style="color:#a6e22e">Field</span>(<span style="color:#a6e22e">i</span>).<span style="color:#a6e22e">Name</span>] = <span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Interface</span>()
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
}
</code></pre></div><ol start="3">
<li><code>encoding/json</code> hack</li>
</ol>
<p>A more established go dev may be tempted to try the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hack</span>(<span style="color:#a6e22e">foo</span> <span style="color:#a6e22e">Foo</span>) <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{} {

	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{})

	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">foo</span>)
	<span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">result</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
}
</code></pre></div><p>Much shorter than option 1, but we&rsquo;ll find it&rsquo;s much less efficient.</p>
<hr>
<h2 id="results">Results</h2>
<p>We can benchmark these functions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// to elim some compiler optimizations
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">result</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkBase</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>) {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">m</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">n</span> &lt; <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">N</span>; <span style="color:#a6e22e">n</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">m</span> = <span style="color:#a6e22e">base</span>(<span style="color:#a6e22e">foo</span>)
	}
	<span style="color:#a6e22e">result</span> = <span style="color:#a6e22e">m</span>
}
</code></pre></div><p>Benchmarking on my machine I get results like:</p>
<pre><code>$ go test -bench=. -benchtime=60s

goos: linux
goarch: amd64
pkg: github.com/smantic/bench-struct-to-map
cpu: Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz
BenchmarkBase-8      	133096639	       538.1 ns/op
BenchmarkHack-8      	47031236	      1591 ns/op
BenchmarkReflect-8   	72736426	       965.5 ns/op
PASS
ok  	github.com/smantic/bench-struct-to-map	273.862s
</code></pre><p>We see that the option 1 has a speedup of ~2x compared to the reflect method, and ~3x speedup when compared to the encoding/json hack.</p>
<p>Option 1 is probably faster due to the following ideas:</p>
<ol>
<li>runtime reflection is slow</li>
<li>encoding/json has extra logic for json handling
<ul>
<li>we are also doing an extra step to convert the struct to a byte array of json data.</li>
<li>encoding/json uses reflection to do this in the first place.</li>
</ul>
</li>
</ol>
<p>The base option is just assigning entries in the map, and lets the compiler handle the rest.</p>
<p>Makes me feel a bit better about writing out the struct mapping by hand!</p>
<p>code : <a href="https://github.com/smantic/bench-struct-to-map">https://github.com/smantic/bench-struct-to-map</a></p>
<hr>
<h3 id="other-libraries">Other Libraries</h3>
<p>If you google &ldquo;go struct to map&rdquo; you are likely to stumble upon <a href="https://stackoverflow.com/questions/23589564/function-for-converting-a-struct-to-map-in-golang">this SO post</a>.<br>
The accepted answer mentions <a href="https://github.com/fatih/structs">fatih/structs</a>. However, this project still uses reflection and has been unmaintained for years.</p>
<p>Any other project will likely have performance worse or close to the reflection method, since they will all be using reflection underneath.</p>
<p>You may also find <a href="https://github.com/mitchellh/mapstructure">mitchellh/mapstructure</a>, which still uses reflection.<br>
For fun here&rsquo;s the benchmark for that.</p>
<pre><code>$ go test -bench=Mitchellh -benchtime=60s

goos: linux
goarch: amd64
pkg: github.com/smantic/bench-struct-to-map
cpu: Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz
BenchmarkMitchellh-8   	11661878	      6298 ns/op
PASS
ok  	github.com/smantic/bench-struct-to-map	79.679s
</code></pre><p>Â¯\_(ãƒ„)_/Â¯</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="https://blog.smantic.dev/posts/reddit/">
                  <span class="button__text">reddit</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>
    </div>
    <div class="footer"> 
      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >smantics</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >Â© 2021 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="https://blog.smantic.dev/assets/main.js"></script>
<script src="https://blog.smantic.dev/assets/prism.js"></script>



      
    </div> 

    
  </body>
</html>
